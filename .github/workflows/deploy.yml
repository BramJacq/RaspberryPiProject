name: Bramj Continuous Deployment

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Set up QEMU + Buildx (for cross-compiling)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3️⃣ Build Docker image for ARM64 (Raspberry Pi)
      - name: Build Docker image (ARM64)
        run: docker build -t bramj_builder --platform=linux/arm64 .

      # 4️⃣ Compile inside Docker
      - name: Compile inside Docker
        run: |
          docker run --rm -v ${{ github.workspace }}:/work bramj_builder \
            bash -c "
              cd /work
              echo 'Start compiling...'
              gcc -c pigpio/*.c -I/usr/include/pigpio
              ar rcs libpigpio.a *.o
              gcc main.c -L. -lpigpio -lpthread -o main
              echo 'Compilation successful, executable is main'
            "

      # 5️⃣ Setup SSH private key from GitHub Secrets
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PI_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # 6️⃣ Add Raspberry Pi host to known_hosts to avoid SSH warnings
      - name: Add Pi to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.PI_HOST }} >> ~/.ssh/known_hosts

      # 7️⃣ Upload binary to Raspberry Pi using key-based SCP
      - name: Upload binary to Raspberry Pi
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes ./main bramtimo@${{ secrets.PI_HOST }}:/home/bramtimo/main

      # 8️⃣ Restart program via SSH on Raspberry Pi
      - name: Restart program on Raspberry Pi
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes bramtimo@${{ secrets.PI_HOST }} << 'EOF'
          cd /home/bramtimo
          chmod +x main
          tmux kill-session -t bramj || true
          tmux new -d -s bramj "./main"
          EOF
