name: Bramj Continuous Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Set up QEMU + Docker Buildx
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3️⃣ Build Docker image for ARM64
      - name: Build Docker image (ARM64)
        run: docker build -t bramj_builder --platform=linux/arm64 .

      # 4️⃣ Compile inside Docker
      - name: Compile inside Docker
        run: |
          docker run --rm -v ${{ github.workspace }}:/work bramj_builder bash -c "
          cd /work
          echo 'Start compiling...'
          gcc main.c -o main \
            -lpigpio \
            -lbcm2835 \
            -lpthread \
            -lrt
          echo 'Compilation successful, executable is main'
          "

      # 5️⃣ Ensure SSH directory exists
      - name: Ensure SSH directory
        shell: powershell
        run: |
          $sshDir = Join-Path $env:USERPROFILE ".ssh"
          if (-Not (Test-Path $sshDir)) {
            New-Item -ItemType Directory -Path $sshDir | Out-Null
          }
          Write-Host ".ssh directory ready at $sshDir"

      # 6️⃣ Write SSH private key safely (FIXED FOR REAL)
      - name: Write SSH private key
        shell: powershell
        run: |
          $sshDir = Join-Path $env:USERPROFILE ".ssh"
          $keyPath = Join-Path $sshDir "id_rsa_bramj"

          # Ensure directory exists
          if (-Not (Test-Path $sshDir)) {
            New-Item -ItemType Directory -Path $sshDir | Out-Null
          }

          # If key exists, restore write permission
          if (Test-Path $keyPath) {
            icacls $keyPath /grant "$($env:USERNAME):(F)" | Out-Null
          }

          # Write (overwrite) key
          Set-Content -Path $keyPath -Value $env:PI_PRIVATE_KEY -NoNewline

          # Lock permissions back down
          icacls $keyPath /inheritance:r | Out-Null
          icacls $keyPath /grant:r "$($env:USERNAME):(R)" | Out-Null

          Write-Host "Private key written to $keyPath"
        env:
          PI_PRIVATE_KEY: ${{ secrets.PI_SSH_KEY }}


      # 7️⃣ Upload binary to Raspberry Pi
      - name: Upload binary to Raspberry Pi
        shell: powershell
        run: |
          $sshDir = Join-Path $env:USERPROFILE ".ssh"
          $keyPath = Join-Path $sshDir "id_rsa_bramj"
          $piHost = $env:PI_HOST
          $piUser = $env:PI_USER
          $localFile = Join-Path $env:GITHUB_WORKSPACE "main"
          $remoteFile = "/home/$piUser/main"
          $remotePath = "${piUser}@${piHost}:$remoteFile"
          Write-Host "Uploading $localFile to $remotePath ..."
          scp -i $keyPath -o StrictHostKeyChecking=no $localFile $remotePath
          Write-Host "Upload complete."
        env:
          PI_HOST: ${{ secrets.PI_HOST }}
          PI_USER: ${{ secrets.PI_USER }}

    # 8️⃣ Restart program on Raspberry Pi (FIXED)
    - name: Restart program on Raspberry Pi
      shell: powershell
      run: |
        $sshDir = Join-Path $env:USERPROFILE ".ssh"
        $keyPath = Join-Path $sshDir "id_rsa_bramj"
        $piHost = $env:PI_HOST
        $piUser = $env:PI_USER
    
        ssh -i $keyPath -o StrictHostKeyChecking=no "$piUser@$piHost" `
          "cd /home/$piUser && chmod +x main && tmux kill-session -t bramj || true && tmux new -d -s bramj ./main"
      env:
        PI_HOST: ${{ secrets.PI_HOST }}
        PI_USER: ${{ secrets.PI_USER }}
